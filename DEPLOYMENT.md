# Deployment Guide for Urja View Mobile

This document describes the automated deployment process for the Urja View mobile application using Codemagic CI/CD.

## Overview

The deployment process is fully automated through Git tags and Codemagic workflows. Build numbers are automatically managed by Codemagic to ensure each build has a unique version code.

## Version Numbering

- **Version Format**: `MAJOR.MINOR.PATCH` (e.g., 1.0.22)
- **Build Number**: Automatically generated by Codemagic using `$CM_BUILD_ID`
- **Final Version**: `VERSION+BUILD_NUMBER` (e.g., 1.0.22+1234)

## Deployment Process

### 1. Tag-Based Releases

Create and push tags to trigger builds:

```bash
# For iOS release
git tag -a ios-1.0.23 -m "iOS release 1.0.23"
git push origin ios-1.0.23

# For Android release  
git tag -a android-1.0.5 -m "Android release 1.0.5"
git push origin android-1.0.5

# Deploy both platforms
git tag -a ios-1.0.23 -m "iOS release 1.0.23"
git tag -a android-1.0.5 -m "Android release 1.0.5"
git push origin ios-1.0.23 android-1.0.5
```

### 2. Automatic Build Process

When tags are pushed:

1. **Codemagic detects the tag** and starts the appropriate workflow
2. **Version extraction**: The version is extracted from the tag (e.g., `ios-1.0.23` â†’ `1.0.23`)
3. **Build number assignment**: Codemagic assigns a unique build ID
4. **Version update**: `pubspec.yaml` is automatically updated with `version: 1.0.23+BUILD_ID`
5. **Build creation**: Flutter builds with the specified version and build number
6. **Publishing**: 
   - iOS: Uploaded to TestFlight
   - Android: Uploaded to Google Play Internal track

### 3. Build Number Management

The build number is automatically managed by Codemagic:

- Uses `$CM_BUILD_ID` environment variable
- Ensures unique build numbers for App Store/Google Play
- No manual version code management required
- Prevents "duplicate version" errors

## Monitoring Builds

1. **Codemagic Dashboard**: https://codemagic.io/app/6889ea6e98fd14e47f40dd2a
2. **Email Notifications**: Build status sent to rohan@indotechmeter.com
3. **Build Logs**: Available in Codemagic for troubleshooting

## Pre-Deployment Checklist

Before creating release tags:

1. Ensure all code is committed and pushed
2. Run `flutter analyze` - must pass with no errors
3. Run `flutter test` - all tests must pass
4. Update CHANGELOG.md with release notes
5. Verify no sensitive data in code

## Troubleshooting

### Common Issues

1. **"Bundle version already exists" error**
   - This is now automatically handled by using Codemagic build numbers
   - Each build gets a unique build number

2. **Build fails on flutter analyze**
   - Fix all static analysis issues before tagging
   - Run `flutter analyze --fatal-infos` locally

3. **Signing issues**
   - Verify provisioning profiles in Codemagic settings
   - Check certificate expiration dates

## Version History

Track released versions:
```bash
# List all iOS releases
git tag -l "ios-*" | sort -V

# List all Android releases  
git tag -l "android-*" | sort -V
```

## Rollback Process

If a release has issues:

1. Do not delete the tag (keep for history)
2. Create a new patch version with fixes
3. Tag and deploy the fixed version

## Environment Variables

Required in Codemagic:
- `APP_STORE_CONNECT_API_KEY` - For iOS publishing
- `GCLOUD_SERVICE_ACCOUNT_CREDENTIALS` - For Android publishing
- Certificate and provisioning profile configurations

## Best Practices

1. **Semantic Versioning**: Follow MAJOR.MINOR.PATCH convention
2. **Release Notes**: Always include meaningful commit messages
3. **Testing**: Deploy to TestFlight/Internal track first
4. **Gradual Rollout**: Use phased releases for production
5. **Monitoring**: Check crash reports after each release